<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Recuerdos de Familia</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #ff6b6b;
      --secondary-color: #4ecdc4;
      --background-color: #f7f7f7;
      --text-color: #2d3436;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      line-height: 1.6;
      padding: 2rem;
    }

    h1 {
      text-align: center;
      color: var(--primary-color);
      font-size: 2.5rem;
      margin-bottom: 2rem;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
    }

    .formulario {
      background: white;
      padding: 2rem;
      border-radius: 15px;
      box-shadow: var(--shadow);
      max-width: 600px;
      margin: 0 auto 2rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    input[type="file"] {
      border: 2px dashed var(--secondary-color);
      padding: 1rem;
      border-radius: 8px;
      width: 100%;
      cursor: pointer;
    }

    select {
      padding: 0.8rem;
      border: 2px solid var(--secondary-color);
      border-radius: 8px;
      font-size: 1rem;
      outline: none;
      cursor: pointer;
    }

    button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 1rem;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      transition: transform 0.2s, background-color 0.2s;
    }

    button:hover {
      background-color: #ff5252;
      transform: translateY(-2px);
    }

    .galeria {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 2rem;
      padding: 1rem;
    }

    .galeria > div {
      background: white;
      padding: 1rem;
      border-radius: 15px;
      box-shadow: var(--shadow);
      transition: transform 0.3s;
      cursor: pointer;
    }

    .galeria > div:hover {
      transform: translateY(-5px);
    }

    .galeria img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 0.5rem;
    }

    .galeria p {
      text-align: center;
      color: var(--text-color);
      font-weight: 500;
      text-transform: capitalize;
    }

    @media (max-width: 768px) {
      body {
        padding: 1rem;
      }

      h1 {
        font-size: 2rem;
      }

      .galeria {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      }
      
      
    }
    .overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.8);
  z-index: 1000;
  justify-content: center;
  align-items: center;
  flex-direction: column;
}

.overlay.active {
  display: flex;
}

.overlay img {
  max-width: 90%;
  max-height: 80vh;
  border-radius: 8px;
  margin-bottom: 1rem;
}

.overlay-content {
  color: white;
  text-align: center;
  margin-top: 1rem;
}

.overlay-close {
  position: absolute;
  top: 20px;
  right: 20px;
  color: white;
  font-size: 2rem;
  cursor: pointer;
  background: none;
  border: none;
  padding: 0.5rem;
}

.formulario input[type="text"], 
.formulario textarea {
  width: 100%;
  padding: 0.8rem;
  border: 2px solid var(--secondary-color);
  border-radius: 8px;
  font-size: 1rem;
  outline: none;
}

.formulario textarea {
  resize: vertical;
  min-height: 100px;
}




  </style>
</head>
<body>

<h1>Recuerdos copito</h1>
<div align="center">
    <button onclick="window.location='carnet.html'">Carnet Copito</button>


<div class="formulario">
  <input type="file" id="foto" accept="image/*" required>
  <input type="text" id="titulo" placeholder="Título de la foto" required>
  <select id="categoria">
    <option value="mascotas">Mascota</option>
  </select>
  <button onclick="subirFoto()">Subir Foto</button>
</div>

<div class="galeria" id="galeria"></div>

<div class="overlay" id="overlay">
  <button class="overlay-close" onclick="cerrarOverlay()">&times;</button>
  <img id="overlay-img">
  <div class="overlay-content">
    <h2 id="overlay-titulo"></h2>
    <p id="overlay-descripcion"></p>
  </div>
</div>

<!-- Primero el script de Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
  const SUPABASE_URL = 'https://ujjoocfesmsbjyibdsez.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVqam9vY2Zlc21zYmp5aWJkc2V6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU3NzkyNjEsImV4cCI6MjA2MTM1NTI2MX0.xMRUmyP9jquM7nA647Ewgobghcc4YQZBIfTdJ0yWws8';
  const BUCKET_NAME = 'fotos-familia';

  const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  async function subirFoto() {
    const archivoInput = document.getElementById('foto');
    const titulo = document.getElementById('titulo').value;
    const categoria = document.getElementById('categoria').value;
    const archivo = archivoInput.files[0];

    if (!archivo || !titulo || !descripcion) {
      alert('Por favor complete todos los campos.');
      return;
    }

    // Codificar los metadatos en el nombre del archivo
    const metadataStr = `${encodeURIComponent(titulo)}__${encodeURIComponent(descripcion)}`;
    const nombreArchivo = `${categoria}/${Date.now()}_${metadataStr}_${archivo.name}`;

    try {
      const { data, error } = await client.storage.from(BUCKET_NAME).upload(nombreArchivo, archivo, {
        upsert: true
      });

      if (error) {
        alert('Error al subir la foto');
        console.error(error);
      } else {
        alert('Foto subida con éxito');
        document.getElementById('titulo').value = '';
        document.getElementById('descripcion').value = '';
        document.getElementById('foto').value = '';
        mostrarFotos();
      }
    } catch (error) {
      console.error('Error al subir la foto:', error);
      alert('Error al subir la foto');
    }
  }

  async function mostrarFotos() {
    const galeria = document.getElementById('galeria');
    galeria.innerHTML = '';

    try {
      const { data: carpetas, error } = await client.storage.from(BUCKET_NAME).list('', { limit: 100 });

      if (error) {
        console.error('Error al listar carpetas:', error);
        return;
      }

      for (const carpeta of carpetas) {
        if (carpeta.name === 'recuerdos' || carpeta.name === 'mascotas') {
          const { data: fotos, error: fotosError } = await client.storage.from(BUCKET_NAME).list(carpeta.name, { limit: 100 });

          if (fotosError) {
            console.error(`Error al listar fotos de ${carpeta.name}:`, fotosError);
            continue;
          }

          for (const foto of fotos) {
            try {
              let titulo = 'Sin título';
              let descripcion = 'Sin descripción';

              // Intentar extraer los metadatos del nombre del archivo
              const partes = foto.name.split('_');
              if (partes.length >= 3) {
                titulo = decodeURIComponent(partes[1]);
                descripcion = decodeURIComponent(partes[2].split('_')[0]);
              }
              
              const url = `${SUPABASE_URL.replace('/rest/v1', '')}/storage/v1/object/public/${BUCKET_NAME}/${carpeta.name}/${foto.name}`;

              const div = document.createElement('div');
              div.innerHTML = `
                <img src="${url}" alt="${titulo}">
                <p>${titulo}</p>
              `;
              div.onclick = () => abrirOverlay(url, { titulo, descripcion });
              galeria.appendChild(div);
            } catch (fotoError) {
              console.error('Error al procesar foto:', fotoError);
            }
          }
        }
      }
    } catch (error) {
      console.error('Error general en mostrarFotos:', error);
    }
  }

  function abrirOverlay(url, metadata) {
    const overlay = document.getElementById('overlay');
    const overlayImg = document.getElementById('overlay-img');
    const overlayTitulo = document.getElementById('overlay-titulo');
    const overlayDescripcion = document.getElementById('overlay-descripcion');

    overlayImg.src = url;
    overlayTitulo.textContent = metadata.titulo;
    overlayDescripcion.textContent = metadata.descripcion;
    overlay.classList.add('active');
  }

  function cerrarOverlay() {
    const overlay = document.getElementById('overlay');
    overlay.classList.remove('active');
  }

  mostrarFotos();
</script>

</body>
</html>

